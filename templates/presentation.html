{% extends "base.html" %}
{% block title %}PrÃ©sentation dÃ©taillÃ©e{% endblock %}

{% block content %}
<h2 class="text-center mb-5 animate__animated animate__fadeInDown">
  DÃ©tection de Fraudes par Autoâ€‘encodeur<br>
  <small class="fs-5 text-muted">de lâ€™EDA au dÃ©ploiement</small>
</h2>
<!-- 0. Story intro ----------------------------------------------------------->
<section id="story" class="mb-6" data-aos="fade-up">
  <h3>ğŸ•µï¸â€â™‚ï¸Â Une matinÃ©e (presque) tranquilleâ€¦</h3>

  <p>
    Dimanche matin Ã  Casablanca. Le quartier est encore endormiâ€¯; tu ouvres les
    volets en pensant profiter dâ€™une journÃ©e paisible. <strong>Soudain</strong>,
    ton tÃ©lÃ©phone vibreâ€¯: appel international.
  </p>

  <p>
    â€”â€¯Â«â€¯<b>SalamÂ alekoum</b>, ici <strong>Amine</strong>,
    votre conseiller bancaire.â€¯Â»  
    Sa voix est douce mais pressanteÂ :  
    â€”â€¯Â«â€¯Avezâ€‘vous autorisÃ© un paiement de <strong>12â€¯450â€¯MAD</strong>
    pour dix&nbsp;<i>iPhoneÂ 15Â Pro Max</i>Â ?â€¯Â»
  </p>

  <p>
    Ton cÅ“ur sâ€™emballeâ€¯; Ã©videmment, tu nâ€™as jamais achetÃ© autant dâ€™iPhone dâ€™un
    coupâ€¯!  
    â€”â€¯Â«â€¯Non, absolument pasâ€¯!â€¯Â»  
    Youssef conclut aussitÃ´tÂ :  
    â€”â€¯Â«â€¯Shukran. Nous bloquons la transaction et lanÃ§ons une vÃ©rification.â€¯Â»
  </p>

  <p>
    <strong>Comment</strong> Youssef aâ€‘tâ€‘il su que ce paiement Ã©tait
    suspectâ€¯? Chaque jour, les algorithmes de
    <em>dÃ©tection dâ€™anomalies</em> scannent des millions de transactions et
    lÃ¨vent lâ€™alerte dÃ¨s quâ€™une opÃ©ration sâ€™Ã©carte trop du
    comportement habituel de la carte.
  </p>

  <figure class="text-center my-4">
    <img src="{{ url_for('static', filename='img/context.jpg') }}"
         class="img-fluid rounded shadow" style="max-width:480px"
         alt="Illustration appel fraude">
    <figcaption class="text-muted">
      La fraude bancaire mondiale reprÃ©sente plus de 21â€¯milliardsâ€¯$ de pertes
      annuelles (NilsonÂ Report).
    </figcaption>
  </figure>

  <p>
    Dans cette prÃ©sentation, nous allons voir comment construire â€” et dÃ©ployer â€”
    un <strong>autoâ€‘encodeur</strong> capable de repÃ©rer ces transactions
    suspectes avant quâ€™elles nâ€™impactent vos finances.
  </p>
</section>


<!-- 1. Introduction ----------------------------------------------------------->
<section id="intro" data-aos="fade-up" class="mb-6">
  <h3>1ï¸âƒ£Â IntroductionÂ : pourquoi lâ€™<em>anomaly detectionÂ ?</em></h3>
  <p>
    Dans la plupart des systÃ¨mes financiers, la fraude est un phÃ©nomÃ¨ne
    <strong>extrÃªmement rare</strong>Â â€” typiquement moins de 0,2â€¯% des transactions.
    Cette raretÃ© rend les modÃ¨les supervisÃ©s dÃ©licatsÂ : il faut beaucoup de
    rÃ©â€‘Ã©chantillonnage, et ils ont du mal Ã  gÃ©nÃ©raliser Ã  de <em>nouvelles</em>
    formes de fraude.
  </p>
  <p>
    Lâ€™<strong>autoâ€‘encodeur</strong> (AE) est une approche nonâ€‘supervisÃ©e qui
    apprend la Â«â€¯normalitÃ©â€¯Â»Â : on le
    <em>force</em> Ã  compresser puis reconstruire les transactions lÃ©gitimes.
    Toute transaction mal reconstruite, câ€‘Ã â€‘d. avec une erreur de
    reconstruction Ã©levÃ©e, est signalÃ©e comme anomalieÂ â†’Â <strong>fraudeÂ ?</strong>
  </p>
</section>

<!-- 2. Dataset & features ----------------------------------------------------->
<section id="dataset" class="row gy-5 align-items-center mb-6">
  <div class="col-lg-6" data-aos="fade-right">
    <h3>2ï¸âƒ£Â DatasetÂ : 200â€¯000 transactions Retail</h3>
    <ul>
      <li>200â€¯000 Ã©chantillons aprÃ¨s Ã©quilibrage dÃ©mo (initialement 284â€¯k).</li>
      <li><strong>17â€¯462 fraudes</strong> (â‰ˆâ€¯8,7â€¯%).</li>
      <li>7Â features expertes &nbsp;â€”&nbsp;3Â numÃ©riques + 4Â binaires.</li>
    </ul>
    <h5 class="mt-4">Liste &amp; signification des featuresÂ :</h5>
    <table class="table table-sm table-borderless">
      <tr><th>distance_from_home</th><td>Distance (km) entre domicile et lieu dâ€™achat.</td></tr>
      <tr><th>distance_from_last_transaction</th><td>Distance (km) depuis la transaction prÃ©cÃ©dente.</td></tr>
      <tr><th>ratio_to_median_purchase_price</th><td>Montant / mÃ©diane historique du porteur.</td></tr>
      <tr><th>repeat_retailer</th><td>(1/0) CommerÃ§ant dÃ©jÃ  visitÃ©Â ?</td></tr>
      <tr><th>used_chip</th><td>(1/0) Carte insÃ©rÃ©e (puce) vs bande.</td></tr>
      <tr><th>used_pin_number</th><td>(1/0) Saisie dâ€™un codeÂ PIN.</td></tr>
      <tr><th>online_order</th><td>(1/0) Transaction en ligne.</td></tr>
    </table>
  </div>

  <div class="col-lg-6 text-center" data-aos="fade-left">
    <img src="{{ url_for('static', filename='img/output_16_0.png') }}"
         class="img-fluid rounded shadow" alt="Classe Genuine vs Fraud">
    <figcaption class="text-muted">Figâ€¯1Â â€‘ RÃ©partition Genuine / Fraud (8,7â€¯% de fraudes).</figcaption>
  </div>
</section>

<!-- 3. EDA -------------------------------------------------------------------->
<section id="eda" data-aos="fade-up" class="mb-6">
  <h3>3ï¸âƒ£Â Exploration des donnÃ©es (EDA)</h3>

  <h5 class="mt-4">3.1Â CorrÃ©lations</h5>
  <p>
    Les corrÃ©lations demeurent faibles &nbsp;â€”&nbsp;
    <em>ratio_to_median_purchase_price</em> ressort comme la variable la plus
    corrÃ©lÃ©e Ã  la fraude (0,46). Les autres restent quasi indÃ©pendantes,
    justifiant lâ€™usage dâ€™un modÃ¨le nonâ€‘linÃ©aire.
  </p>
  <img src="{{ url_for('static', filename='img/output_18_0.png') }}"
       class="img-fluid rounded shadow mb-4" alt="Heatmap corrÃ©lation">

  <h5>3.2Â Distribution des distances (logâ€‘scale)</h5>
  <div class="row gy-4">
    <div class="col-md-6 text-center">
      <img src="{{ url_for('static', filename='img/output_20_0.png') }}"
           class="img-fluid rounded shadow" alt="Distance from home">
    </div>
    <div class="col-md-6 text-center">
      <img src="{{ url_for('static', filename='img/output_21_0.png') }}"
           class="img-fluid rounded shadow" alt="Distance from last txn">
    </div>
  </div>
  <p class="mt-3">
    Les fraudes (courbe orange) se dÃ©placent davantageÂ : pics autour de 80â€‘100â€¯km
    pour la distance au domicile et >â€¯10â€¯km pour la distance Ã  la derniÃ¨re
    transaction.
  </p>

  <h5 class="mt-4">3.3Â Variables binaires</h5>
  <img src="{{ url_for('static', filename='img/output_22_0.png') }}"
       class="img-fluid rounded shadow" alt="Barplots binaires">
  <p>
    Fait marquantÂ : les fraudes se produisent plus souventÂ <i>sans</i> saisie
    PIN et via commande en ligneÂ â€” un signal fort exploitÃ© par lâ€™AE.
  </p>
</section>

<!-- 4. Autoâ€‘encodeur ---------------------------------------------------------->
<section id="ae" data-aos="fade-up" class="mb-6">
  <h3>4ï¸âƒ£Â Construction de lâ€™Autoâ€‘encodeur</h3>

  <div class="row gy-4">
    <!-- Diagramme -->
    <div class="col-lg-12 text-center">
      <img src="{{ url_for('static', filename='img/ae_diagram.png') }}"
           class="img-fluid rounded shadow"
           alt="Architecture Autoâ€‘encodeur">
      <figcaption class="text-muted mt-2">
        Figâ€¯XÂ â€‘ SchÃ©ma de lâ€™architecture AEÂ : encodeur (gauche)Â â†’ code latent (jaune)Â â†’ dÃ©codeur (droite).
      </figcaption>
    </div>

    <!-- Explications dÃ©taillÃ©es -->
    <div class="col-lg-12">
      <h5 class="mt-4">DÃ©codage pas Ã  pas</h5>
      <ul>
        <li><strong>InputÂ (7)</strong>Â : vecteur normalisÃ© contenant les 7 features du paiement.</li>

        <li><strong>DenseÂ 64 (ReLU)</strong>Â : premiÃ¨re couche dâ€™encodage.  
            &nbsp;â€¢â€¯64 neurones â‰ˆÂ 9Ã— la dimension dâ€™entrÃ©eâ€¯;  
            &nbsp;â€¢â€¯capture les interactions linÃ©aires et nonâ€‘linÃ©aires de bas niveau.</li>

        <li><strong>DenseÂ 16 (ReLU)</strong>Â : rÃ©duction progressive.  
            La chute 64â€¯â†’â€¯16 force le rÃ©seau Ã  Ã©liminer le bruit et Ã  garder les
            caractÃ©ristiques rÃ©ellement discriminantes.</li>

        <li><strong>BottleneckÂ =Â CodeÂ 5</strong>Â <span class="text-warning">(jaune)</span>Â :  
            cÅ“ur de lâ€™AE.  
            5Â unitÃ©s =â€¯compression Ã—â€¯<strong>1,4</strong> de lâ€™entrÃ©e (7/5).  
            Toute lâ€™Â«â€¯essenceâ€¯Â» dâ€™une transaction lÃ©gitime doit tenir
            iciÂ ; la moindre anomalie se traduira par une reconstruction
            imparfaite plus tard.</li>

        <li><strong>DenseÂ 16Â â†’Â DenseÂ 64</strong>Â : phase de dÃ©codage miroir.  
            On rÃ©â€‘expand progressivement le code pour retrouver lâ€™espace original.</li>

        <li><strong>OutputÂ (7)</strong>Â : couche linÃ©aire (pas dâ€™activation) qui restitue
            les valeurs reconstruites.  
            EntraÃ®nÃ©e avec la <code>MeanÂ AbsoluteÂ Error</code> (MAE) sur les
            transactions <em>genuine</em> seulement.</li>
      </ul>

      <h5 class="mt-4">Pourquoi ce dimensionnementâ€¯?</h5>
      <p>
        <u>Trop petit</u> âœ sousâ€‘apprentissageâ€¯: lâ€™AE ne parvient plus Ã 
        reconstruire mÃªme les transactions normales.  
        <u>Trop grand</u> âœ lâ€™AE Â«â€¯recopieâ€¯Â» la donnÃ©e et ne distingue plus les
        anomalies.  
        64â€¯â†’â€¯16â€¯â†’â€¯5 offre ici le meilleur compromis empirique
        (gridâ€‘search rapide sur quelques dimensions latentes).
      </p>

      <h5 class="mt-4">InterprÃ©tation de lâ€™erreur</h5>
      <p>
        Lâ€™AE minimise &nbsp;<kbd>âˆ‘â€¯|xâ€¯âˆ’â€¯xÌ‚|</kbd>.  
        Pour une transaction <em>normale</em>, la reconstruction est fidÃ¨le
        â†’ erreur basse &lt;â€¯0,01.  
        Pour une transaction <em>frauduleuse</em>, certaines features (montant,
        distance, PIN) sortent du profil appris â†’ erreur haute &gt;â€¯0,01.  
        Câ€™est ce seuil que nous calibrons ensuite (cf. sectionâ€¯6) pour
        sÃ©parer Â«â€¯genuineâ€¯Â»â€¯/â€¯Â«â€¯fraudâ€¯Â».
      </p>
    </div>
  </div>
</section>


<!-- 5. EntraÃ®nement ----------------------------------------------------------->
<section id="training" data-aos="fade-up" class="mb-6">
  <h3>5ï¸âƒ£Â EntraÃ®nement</h3>
  <p>
    Lâ€™AE est entraÃ®nÃ© <u>uniquement</u> sur les transactions <em>genuine</em>.
    <br>ValidationÂ : 10â€¯% de transactions genuine pour suivre le
    <code>val_loss</code>.
  </p>
  <img src="{{ url_for('static', filename='img/output_37_0.png') }}"
       class="img-fluid rounded shadow mb-2" alt="Loss curve">
  <p class="text-muted">Figâ€¯2Â â€‘ Courbe LossÂ : stabilitÃ©, pas de surâ€‘apprentissage.</p>
</section>

<!-- 6. Seuil ------------------------------------------------------------------>
<section id="threshold" data-aos="fade-up" class="mb-6">
  <h3>6ï¸âƒ£Â DÃ©termination du seuil optimal</h3>
  <p>
    On balaie le percentile de lâ€™erreur de reconstruction entre 0â€¯% et 30â€¯%.
    Objectifâ€¯: <strong>maximiser le Recall</strong> tout en gardant une
    prÃ©cision acceptable.
  </p>
  <img src="{{ url_for('static', filename='img/output_45_0.png') }}"
       class="img-fluid rounded shadow mb-2" alt="Metrics vs threshold">
  <p>
    Seuil choisiÂ : <code>0.01</code> (ligne rouge)  
    &nbsp;â†’ Recallâ€¯0.97 â€¢ Precisionâ€¯0.28 â€¢ F1â€¯0.44.
  </p>
</section>

<!-- 7. RÃ©sultats -------------------------------------------------------------->
<section id="results" data-aos="fade-up" class="mb-6">
  <h3>7ï¸âƒ£Â Analyse des rÃ©sultats</h3>
  <div class="row gy-4">
    <div class="col-md-6 text-center">
      <img src="{{ url_for('static', filename='img/output_46_0.png') }}"
           class="img-fluid rounded shadow" alt="Scatter errors">
      <figcaption class="text-muted">Dispersion des erreurs (ligne rougeâ€¯=â€¯seuil).</figcaption>
    </div>
    <div class="col-md-6 text-center">
      <img src="{{ url_for('static', filename='img/output_51_0.png') }}"
           class="img-fluid rounded shadow" alt="Confusion matrix">
      <figcaption class="text-muted">Matrice de confusion (test 200â€¯k Ã©chantillons).</figcaption>
    </div>
  </div>

  <h5 class="mt-4">InterprÃ©tation</h5>
  <ul>
    <li>97â€¯% des fraudes dÃ©tectÃ©es â€¯â†’ faux nÃ©gatifs trÃ¨s faibles.</li>
    <li>PrÃ©cision 28â€¯% â€¯â†’ ~3,5Â alertes pour 1 vraie fraude
        &nbsp;â€”&nbsp; acceptable pour un filtre de premier niveau.</li>
  </ul>
</section>

<!-- 8. DÃ©ploiement ------------------------------------------------------------>
<section id="deploy" data-aos="fade-up" class="mb-6">
  <h3>8ï¸âƒ£Â DÃ©ploiement &amp; dÃ©mo</h3>
  <p>
    Le modÃ¨le et lâ€™API Flask sont encapsulÃ©s dans un conteneur DockerÂ ; lâ€™image
    est poussÃ©e sur GoogleÂ ContainerÂ Registry puis dÃ©ployÃ©e sur
    <strong>CloudÂ Run</strong> pour bÃ©nÃ©ficier de lâ€™autoâ€‘scaling.
  </p>
  <img src="{{ url_for('static', filename='img/cloud_run.png') }}"
       class="img-fluid rounded shadow mb-3" alt="Cloud Run architecture">
  <p>
      ğŸ‘‰Â Testez par vousâ€‘mÃªme dans lâ€™onglet <a href="{{ url_for('analyse') }}">Analyse</a>.
  </p>
</section>

<!-- 9. Conclusion ------------------------------------------------------------->
<section id="conclusion" data-aos="fade-up" class="mb-6">
  <h3>9ï¸âƒ£Â Conclusion &amp; pistes futures</h3>
  <ul>
    <li>AE nonâ€‘supervisÃ©Â : robuste pour capter des fraudes inÃ©dites.</li>
    <li>Peut servir de <em>prÃ©â€‘filtre</em> avant un modÃ¨le supervisÃ©
        (XGBoost) pour amÃ©liorer la prÃ©cision.</li>
    <li>Prochaine Ã©tapeÂ : entraÃ®nement incrÃ©mental + seuil dynamique
        (adaptÃ© Ã  la dÃ©rive des donnÃ©es).</li>
  </ul>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded",()=>{
  new Chart(document.getElementById("donut"),{
    type:"doughnut",
    data:{
      labels:["Genuine","Fraud"],
      datasets:[{data:[182538,17462],
                 backgroundColor:["#0d6efd","#dc3545"]}]
    },
    options:{plugins:{legend:{position:"bottom"}},cutout:"55%"}
  });
});
</script>
{% endblock %}
